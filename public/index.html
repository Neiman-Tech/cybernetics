<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Web IDE with Terminal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #1e1e1e;
      --bg-secondary: #252526;
      --bg-tertiary: #2d2d30;
      --text-primary: #cccccc;
      --text-secondary: #969696;
      --accent: #007acc;
      --accent-hover: #1a8ed6;
      --border: #3e3e42;
      --success: #4caf50;
      --warning: #ff9800;
      --error: #f44336;
    }

    [data-theme="light"] {
      --bg-primary: #ffffff;
      --bg-secondary: #f3f3f3;
      --bg-tertiary: #e8e8e8;
      --text-primary: #333333;
      --text-secondary: #666666;
      --border: #d4d4d4;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow-y: hidden;
    }

    /* Top Bar */
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      gap: 1rem;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--bg-tertiary);
      border-radius: 4px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--error);
      animation: pulse 2s infinite;
    }

    .status-dot.connected {
      background: var(--success);
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .toolbar {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .btn:hover:not(:disabled) {
      background: var(--accent-hover);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .btn-icon {
      padding: 0.5rem;
      background: transparent;
      color: var(--text-primary);
      min-width: 36px;
      justify-content: center;
    }

    .btn-icon:hover:not(:disabled) {
      background: var(--bg-tertiary);
    }

    /* Workspace Control Buttons */
    .workspace-controls {
      display: flex;
      gap: 0.25rem;
      background: var(--bg-tertiary);
      border-radius: 4px;
      padding: 0.25rem;
    }

    .workspace-btn {
      padding: 0.4rem 0.6rem;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 3px;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .workspace-btn:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .workspace-btn.active {
      background: var(--accent);
      color: white;
    }

    /* Main Content */
    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .sidebar {
      width: 300px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform 0.3s ease;
    }

    .sidebar.hidden {
      transform: translateX(-100%);
      position: absolute;
      z-index: 100;
    }

    .sidebar-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .path-display {
      font-family: monospace;
      font-size: 0.85rem;
      color: var(--text-secondary);
      padding: 0.5rem 1rem;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      white-space: nowrap;
    }

    .file-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem;
    }

    .file-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.25rem;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-item:hover {
      background: var(--bg-tertiary);
    }

    .file-item.active {
      background: var(--accent);
      color: white;
    }

    .file-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .file-actions {
      display: none;
      gap: 0.25rem;
    }

    .file-item:hover .file-actions {
      display: flex;
    }

    .icon-btn {
      padding: 0.25rem 0.5rem;
      background: transparent;
      border: none;
      color: inherit;
      cursor: pointer;
      border-radius: 3px;
      transition: background 0.2s;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      text-align: center;
      color: var(--text-secondary);
      height: 100%;
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Editor Area */
    .editor-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0;
    }

    .tabs {
      display: flex;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
      min-height: 40px;
    }

    .tab {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: transparent;
      border: none;
      border-right: 1px solid var(--border);
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    .tab:hover {
      background: var(--bg-tertiary);
    }

    .tab.active {
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .tab.modified .tab-name::after {
      content: '●';
      color: var(--warning);
      margin-left: 0.25rem;
    }

    .tab-close {
      margin-left: 0.5rem;
      padding: 0.125rem 0.25rem;
      border-radius: 3px;
      opacity: 0.6;
    }

    .tab-close:hover {
      opacity: 1;
      background: var(--error);
    }

    .editor-container {
      flex: 1;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    #editor {
      flex: 1;
      width: 100%;
      height: 100%;
    }

    .plain-editor {
      flex: 1;
      padding: 1rem;
      background: var(--bg-primary);
      color: var(--text-primary);
      border: none;
      resize: none;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 14px;
      line-height: 1.6;
      outline: none;
    }

    .welcome {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      padding: 2rem;
    }

    .welcome i {
      font-size: 4rem;
      color: var(--accent);
      margin-bottom: 1rem;
    }

    /* Terminal Panel */
    .terminal-panel {
      height: 200px;
      min-height: 150px;
      max-height: calc(100vh - 100px);
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: relative;
      transition: transform 0.3s ease;
      flex-shrink: 0;
    }

    .terminal-panel.hidden {
      transform: translateY(100%);
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
    }

    .terminal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 1rem;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border);
    }

    .terminal-resizer {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      cursor: row-resize;
      background: transparent;
      z-index: 10;
    }

    .terminal-resizer:hover {
      background: var(--accent);
    }

    #terminal {
      flex: 1;
      padding: 0.5rem;
      overflow: hidden;
    }

    /* Mobile overlay toggle */
    .mobile-overlay {
      display: none;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      padding: 2rem;
      border-radius: 8px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .form-input {
      width: 100%;
      padding: 0.75rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: monospace;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .modal-actions {
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
      margin-top: 1.5rem;
    }

    .notification {
      position: fixed;
      top: 1rem;
      right: 1rem;
      padding: 1rem 1.5rem;
      background: var(--bg-secondary);
      border-left: 4px solid var(--success);
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 0.75rem;
      z-index: 2000;
      animation: slideIn 0.3s ease;
      max-width: 90%;
    }

    .notification.error {
      border-left-color: var(--error);
    }

    .notification.warning {
      border-left-color: var(--warning);
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .loading {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--text-secondary);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .top-bar {
        flex-wrap: wrap;
        padding: 0.5rem;
      }

      .logo span {
        display: none;
      }

      .connection-status {
        order: 3;
        width: 100%;
        justify-content: center;
      }

      .toolbar {
        order: 2;
      }

      .btn span {
        display: none;
      }

      .btn {
        padding: 0.5rem;
      }

      .sidebar {
        position: absolute;
        z-index: 100;
        height: 100%;
      }

      .sidebar.hidden {
        transform: translateX(-100%);
      }

      .mobile-overlay {
        display: block;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 99;
      }

      .mobile-overlay.hidden {
        display: none;
      }

      .terminal-panel {
        height: 200px;
      }

      .workspace-controls {
        order: 1;
      }

      .editor {
        font-size: 12px;
        padding: 0.5rem;
      }

      .tab {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
      }
    }

    @media (max-width: 480px) {
      .workspace-btn {
        padding: 0.3rem 0.4rem;
        font-size: 0.8rem;
      }

      .terminal-panel {
        height: 150px;
      }
    }

    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-secondary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="logo">
        <i class="fas fa-code"></i>
        <span>Web IDE</span>
      </div>

      <div class="workspace-controls">
        <button class="workspace-btn active" id="sidebarToggle" onclick="ide.toggleSidebar()" title="Toggle Sidebar">
          <i class="fas fa-folder-tree"></i>
        </button>
        <button class="workspace-btn active" id="editorToggle" onclick="ide.toggleEditor()" title="Toggle Editor">
          <i class="fas fa-file-code"></i>
        </button>
        <button class="workspace-btn active" id="terminalToggle" onclick="ide.toggleTerminal()" title="Toggle Terminal">
          <i class="fas fa-terminal"></i>
        </button>
      </div>

      <div class="connection-status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Disconnected</span>
      </div>

      <div class="toolbar">
        <button class="btn" id="connectBtn" onclick="ide.connect()">
          <i class="fas fa-plug"></i>
          <span>Connect</span>
        </button>
        <button class="btn" id="disconnectBtn" onclick="ide.disconnect()" style="display: none;">
          <i class="fas fa-power-off"></i>
          <span>Disconnect</span>
        </button>
        <button class="btn btn-secondary" onclick="ide.saveFile()" id="saveBtn" disabled>
          <i class="fas fa-save"></i>
          <span>Save</span>
        </button>
        <button class="btn btn-icon" onclick="ide.toggleTheme()" title="Toggle Theme">
          <i class="fas fa-moon" id="themeIcon"></i>
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Mobile Overlay -->
      <div class="mobile-overlay hidden" id="mobileOverlay" onclick="ide.closeSidebarMobile()"></div>

      <!-- Sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <span style="font-weight: 600;">Files</span>
          <div style="display: flex; gap: 0.25rem;">
            <button class="icon-btn" onclick="ide.showNewFileDialog()" title="New File" id="newFileBtn" disabled>
              <i class="fas fa-file-plus"></i>
            </button>
            <button class="icon-btn" onclick="ide.showNewFolderDialog()" title="New Folder" id="newFolderBtn" disabled>
              <i class="fas fa-folder-plus"></i>
            </button>
            <button class="icon-btn" onclick="ide.refreshFiles()" title="Refresh" id="refreshBtn" disabled>
              <i class="fas fa-sync"></i>
            </button>
          </div>
        </div>
        <div class="path-display" id="pathDisplay">~</div>
        <div class="file-list" id="fileList">
          <div class="empty-state">
            <i class="fas fa-plug"></i>
            <p>Connect to view files</p>
          </div>
        </div>
      </div>

      <!-- Editor Area -->
      <div class="editor-area" id="editorArea">
        <div class="tabs" id="tabs"></div>
        <div class="editor-container">
          <div class="welcome" id="welcome">
            <i class="fas fa-terminal"></i>
            <h2>Web IDE</h2>
            <p>Connect to start working</p>
          </div>
          <div id="editor" style="display: none;"></div>
        </div>
      </div>
    </div>

    <!-- Terminal Panel -->
    <div class="terminal-panel" id="terminalPanel">
      <div class="terminal-resizer" id="terminalResizer"></div>
      <div class="terminal-header">
        <span style="font-weight: 600;"><i class="fas fa-terminal"></i> Terminal</span>
        <button class="icon-btn" onclick="ide.clearTerminal()" title="Clear">
          <i class="fas fa-eraser"></i>
        </button>
      </div>
      <div id="terminal"></div>
    </div>
  </div>

  <!-- Connection Modal -->
  <div class="modal" id="connectionModal">
    <div class="modal-content">
      <h2 class="modal-title">Server Configuration</h2>
      <div class="form-group">
        <label class="form-label">API Key</label>
        <input type="password" class="form-input" id="apiKeyInput" value="your-secret-api-key">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="ide.closeModal('connectionModal')">Cancel</button>
        <button class="btn" onclick="ide.performConnect()">Connect</button>
      </div>
    </div>
  </div>

  <!-- File Operation Modal -->
  <div class="modal" id="fileModal">
    <div class="modal-content">
      <h2 class="modal-title" id="fileModalTitle">New File</h2>
      <div class="form-group">
        <label class="form-label" id="fileModalLabel">File Name</label>
        <input type="text" class="form-input" id="fileModalInput" placeholder="filename.txt">
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="ide.closeModal('fileModal')">Cancel</button>
        <button class="btn" onclick="ide.fileModalSubmit()">Create</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
  <script>
    class WebIDE {
      constructor() {
        this.terminal = null;
        this.fitAddon = null;
        this.ws = null;
        this.sessionId = null;
        this.isConnected = false;
        this.currentPath = '~';
        this.workspaceDir = 'workspace';
        this.openFiles = new Map();
        this.activeFile = null;
        this.fileModalCallback = null;
        this.theme = 'dark';
        this.sidebarVisible = true;
        this.editorVisible = true;
        this.terminalVisible = true;
        this.terminalHeight = 200;
        this.monacoEditor = null;
        this.monacoReady = false;
        
        this.init();
      }

      init() {
        this.initMonaco();
        this.initTerminal();
        this.setupEventListeners();
        this.setupResizer();
      }

      initMonaco() {
        require.config({ 
          paths: { 
            'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' 
          } 
        });
        
        require(['vs/editor/editor.main'], () => {
          this.monacoReady = true;
          console.log('Monaco Editor loaded successfully');
        });
      }

      initTerminal() {
        this.terminal = new Terminal({
          cursorBlink: true,
          fontSize: 14,
          fontFamily: "'Fira Code', monospace",
          theme: {
            background: '#1e1e1e',
            foreground: '#d4d4d4',
            cursor: '#00ff00'
          }
        });

        this.fitAddon = new FitAddon.FitAddon();
        this.terminal.loadAddon(this.fitAddon);
        this.terminal.open(document.getElementById('terminal'));
        this.fitAddon.fit();

        this.terminal.writeln('\x1b[1;36m╔═══════════════════════════════════════╗\x1b[0m');
        this.terminal.writeln('\x1b[1;36m║        Web IDE - Terminal Ready       ║\x1b[0m');
        this.terminal.writeln('\x1b[1;36m╚═══════════════════════════════════════╝\x1b[0m');
        this.terminal.writeln('');
        this.terminal.writeln('\x1b[32m✓\x1b[0m Click Connect to start');
        this.terminal.writeln('');

        this.terminal.onData((data) => {
          if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({ type: 'input', data }));
          }
        });

        window.addEventListener('resize', () => {
          const panel = document.getElementById('terminalPanel');
          if (panel && this.terminalHeight) {
            panel.style.height = this.terminalHeight + 'px';
          }
          
          requestAnimationFrame(() => {
            this.fitAddon.fit();
            if (this.ws && this.ws.readyState === WebSocket.OPEN) {
              this.ws.send(JSON.stringify({
                type: 'resize',
                cols: this.terminal.cols,
                rows: this.terminal.rows
              }));
            }
          });
        });
      }

      setupEventListeners() {
        document.addEventListener('keydown', (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            this.saveFile();
          }
          if ((e.ctrlKey || e.metaKey) && e.key === 'w') {
            e.preventDefault();
            if (this.activeFile) this.closeTab(this.activeFile);
          }
          if (e.key === 'Escape') {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
            this.closeSidebarMobile();
          }
        });

        document.getElementById('fileModalInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') this.fileModalSubmit();
        });

        document.getElementById('apiKeyInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') this.performConnect();
        });
      }

      setupResizer() {
        const resizer = document.getElementById('terminalResizer');
        const panel = document.getElementById('terminalPanel');
        let isResizing = false;
        let startY = 0;
        let startHeight = 0;

        resizer.addEventListener('mousedown', (e) => {
          e.preventDefault();
          isResizing = true;
          startY = e.clientY;
          startHeight = panel.offsetHeight;
          document.body.style.cursor = 'row-resize';
          document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', (e) => {
          if (!isResizing) return;
          e.preventDefault();
          
          const delta = startY - e.clientY;
          const newHeight = Math.max(150, Math.min(window.innerHeight - 100, startHeight + delta));
          
          this.terminalHeight = newHeight;
          panel.style.height = newHeight + 'px';
          
          // Fit terminal to new size
          requestAnimationFrame(() => {
            this.fitAddon.fit();
            if (this.ws && this.ws.readyState === WebSocket.OPEN) {
              this.ws.send(JSON.stringify({
                type: 'resize',
                cols: this.terminal.cols,
                rows: this.terminal.rows
              }));
            }
          });
        });

        document.addEventListener('mouseup', () => {
          if (isResizing) {
            isResizing = false;
            document.body.style.cursor = 'default';
            document.body.style.userSelect = '';
          }
        });
      }

      // Workspace controls
      toggleSidebar() {
        this.sidebarVisible = !this.sidebarVisible;
        const sidebar = document.getElementById('sidebar');
        const toggle = document.getElementById('sidebarToggle');
        
        if (this.sidebarVisible) {
          sidebar.classList.remove('hidden');
          toggle.classList.add('active');
          if (window.innerWidth <= 768) {
            document.getElementById('mobileOverlay').classList.remove('hidden');
          }
        } else {
          sidebar.classList.add('hidden');
          toggle.classList.remove('active');
          this.closeSidebarMobile();
        }
      }

      toggleEditor() {
        this.editorVisible = !this.editorVisible;
        const editorArea = document.getElementById('editorArea');
        const toggle = document.getElementById('editorToggle');
        
        if (this.editorVisible) {
          editorArea.style.display = 'flex';
          toggle.classList.add('active');
        } else {
          editorArea.style.display = 'none';
          toggle.classList.remove('active');
        }
      }

      toggleTerminal() {
        this.terminalVisible = !this.terminalVisible;
        const panel = document.getElementById('terminalPanel');
        const toggle = document.getElementById('terminalToggle');
        
        if (this.terminalVisible) {
          panel.classList.remove('hidden');
          toggle.classList.add('active');
          setTimeout(() => this.fitAddon.fit(), 100);
        } else {
          panel.classList.add('hidden');
          toggle.classList.remove('active');
        }
      }

      closeSidebarMobile() {
        if (window.innerWidth <= 768) {
          document.getElementById('mobileOverlay').classList.add('hidden');
        }
      }

      clearTerminal() {
        this.terminal.clear();
        this.showNotification('Terminal cleared', 'success');
      }

      // Connection
      connect() {
        document.getElementById('connectionModal').classList.add('active');
        document.getElementById('apiKeyInput').focus();
      }

      async performConnect() {
        const apiKey = document.getElementById('apiKeyInput').value.trim();
        if (!apiKey) {
          this.showNotification('Please enter API key', 'error');
          return;
        }

        this.closeModal('connectionModal');

        const connectBtn = document.getElementById('connectBtn');
        connectBtn.disabled = true;
        connectBtn.innerHTML = '<i class="loading"></i><span>Connecting...</span>';

        document.getElementById('statusText').textContent = 'Connecting...';
        this.terminal.writeln('\r\n\x1b[33m→ Connecting to server...\x1b[0m');

        try {
          const protocol = window.location.protocol;
          const wsProtocol = protocol === 'https:' ? 'wss:' : 'ws:';
          const host = window.location.host;
          const baseUrl = `${protocol}//${host}`;

          const res = await fetch(`${baseUrl}/api/sessions`, {
            method: 'POST',
            headers: {
              'x-api-key': apiKey,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ userId: 'web-ide-user' })
          });

          if (!res.ok) {
            const error = await res.text();
            throw new Error(`HTTP ${res.status}: ${error}`);
          }

          const session = await res.json();
          this.sessionId = session.sessionId;
          const wsUrl = session.wsUrl;

          this.terminal.writeln(`\x1b[32m✓\x1b[0m Session: \x1b[90m${this.sessionId}\x1b[0m`);

          this.ws = new WebSocket(wsUrl);

          this.ws.onopen = () => {
            this.isConnected = true;
            this.updateConnectionUI(true);
            this.terminal.writeln('\x1b[1;32m✓ Connected!\x1b[0m\r\n');
            this.showNotification('Connected successfully!', 'success');

            this.ws.send(JSON.stringify({
              type: 'start',
              cols: this.terminal.cols,
              rows: this.terminal.rows
            }));
            
            // Initialize workspace
            this.initializeWorkspace();
          };

          this.ws.onmessage = (event) => {
            try {
              const msg = JSON.parse(event.data);
              this.handleWSMessage(msg);
            } catch {
              this.terminal.write(event.data);
            }
          };

          this.ws.onclose = () => {
            this.isConnected = false;
            this.updateConnectionUI(false);
            this.terminal.writeln('\r\n\x1b[31m✗ Disconnected\x1b[0m');
            this.showNotification('Disconnected from server', 'warning');
          };

          this.ws.onerror = (err) => {
            this.showNotification('WebSocket error', 'error');
            console.error('WebSocket error:', err);
          };

        } catch (err) {
          this.showNotification(`Connection failed: ${err.message}`, 'error');
          this.terminal.writeln(`\x1b[31m✗ Error: ${err.message}\x1b[0m`);
          connectBtn.disabled = false;
          connectBtn.innerHTML = '<i class="fas fa-plug"></i><span>Connect</span>';
        }
      }

      handleWSMessage(msg) {
        switch (msg.type) {
          case 'output':
            this.terminal.write(msg.data);
            break;
          case 'ready':
            this.terminal.writeln('\r\n\x1b[1;32m✓ Terminal ready!\x1b[0m\r\n');
            break;
          case 'exit':
            this.terminal.writeln(`\r\n\x1b[31m✗ Process exited (code: ${msg.code})\x1b[0m`);
            break;
        }
      }

      async initializeWorkspace() {
        try {
          // Create workspace directory if it doesn't exist
          this.terminal.writeln('\x1b[33m→ Setting up workspace...\x1b[0m');
          
          // Use simpler commands without waiting for output
          this.ws.send(JSON.stringify({ type: 'input', data: `mkdir -p ${this.workspaceDir}\n` }));
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // Navigate to workspace
          this.ws.send(JSON.stringify({ type: 'input', data: `cd ${this.workspaceDir}\n` }));
          await new Promise(resolve => setTimeout(resolve, 500));
          
          this.currentPath = `~/${this.workspaceDir}`;
          
          // Create sample files
          this.terminal.writeln('\x1b[33m→ Creating sample files...\x1b[0m');
          this.ws.send(JSON.stringify({ type: 'input', data: `cat > README.md << 'EOF'\n# Welcome to Web IDE\n\nStart coding!\nEOF\n` }));
          await new Promise(resolve => setTimeout(resolve, 300));
          
          this.ws.send(JSON.stringify({ type: 'input', data: `cat > hello.js << 'EOF'\nconsole.log("Hello World!");\nEOF\n` }));
          await new Promise(resolve => setTimeout(resolve, 300));
          
          this.ws.send(JSON.stringify({ type: 'input', data: `cat > index.html << 'EOF'\n<!DOCTYPE html>\n<html>\n<body>\n<h1>Hello World</h1>\n</body>\n</html>\nEOF\n` }));
          await new Promise(resolve => setTimeout(resolve, 300));
          
          this.terminal.writeln('\x1b[1;32m✓ Workspace ready!\x1b[0m\r\n');
          
          // Load files with a delay
          setTimeout(() => this.refreshFiles(), 500);
        } catch (err) {
          this.terminal.writeln(`\x1b[31m✗ Workspace setup failed: ${err.message}\x1b[0m`);
          this.showNotification('Workspace setup failed', 'error');
        }
      }

      disconnect() {
        if (this.ws) {
          this.ws.close();
          this.ws = null;
        }
      }

      updateConnectionUI(connected) {
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');

        if (connected) {
          statusDot.classList.add('connected');
          statusText.textContent = 'Connected';
          connectBtn.style.display = 'none';
          disconnectBtn.style.display = 'flex';
          
          ['saveBtn', 'newFileBtn', 'newFolderBtn', 'refreshBtn'].forEach(id => {
            document.getElementById(id).disabled = false;
          });
        } else {
          statusDot.classList.remove('connected');
          statusText.textContent = 'Disconnected';
          connectBtn.style.display = 'flex';
          connectBtn.disabled = false;
          connectBtn.innerHTML = '<i class="fas fa-plug"></i><span>Connect</span>';
          disconnectBtn.style.display = 'none';

          ['saveBtn', 'newFileBtn', 'newFolderBtn', 'refreshBtn'].forEach(id => {
            document.getElementById(id).disabled = true;
          });
        }
      }

      // File Operations
      async executeCommand(command) {
        return new Promise((resolve, reject) => {
          if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
            reject(new Error('Not connected'));
            return;
          }

          const marker = `__CMD_${Date.now()}_${Math.random().toString(36).slice(2)}__`;
          let output = '';
          let fullOutput = '';
          let capturing = false;
          let startFound = false;
          
          const timeout = setTimeout(() => {
            this.ws.removeEventListener('message', handler);
            console.error('Command timeout. Full output:', fullOutput);
            reject(new Error('Command timeout'));
          }, 15000);

          const handler = (event) => {
            try {
              const msg = JSON.parse(event.data);
              if (msg.type === 'output') {
                const data = msg.data;
                fullOutput += data;
                
                // Check for start marker
                if (data.includes(`START_${marker}`) || fullOutput.includes(`START_${marker}`)) {
                  startFound = true;
                  capturing = true;
                  // Remove everything before and including the start marker
                  const startIdx = fullOutput.indexOf(`START_${marker}`);
                  if (startIdx !== -1) {
                    output = fullOutput.substring(startIdx + `START_${marker}`.length);
                    fullOutput = output;
                  }
                  return;
                }
                
                // Check for end marker
                if (data.includes(`END_${marker}`) || fullOutput.includes(`END_${marker}`)) {
                  clearTimeout(timeout);
                  this.ws.removeEventListener('message', handler);
                  
                  // Extract content between markers
                  let result = fullOutput;
                  const endIdx = result.indexOf(`END_${marker}`);
                  if (endIdx !== -1) {
                    result = result.substring(0, endIdx);
                  }
                  
                  // Clean up the result
                  result = result
                    .replace(/START_.*?__/g, '')
                    .replace(/END_.*?__/g, '')
                    .replace(/\r/g, '')
                    .trim();
                  
                  resolve(result);
                  return;
                }
                
                if (capturing) {
                  output += data;
                }
              }
            } catch (e) {
              console.error('Handler error:', e);
            }
          };

          this.ws.addEventListener('message', handler);
          
          // Send command with markers
          this.ws.send(JSON.stringify({ 
            type: 'input', 
            data: `echo "START_${marker}"; ${command}; echo "END_${marker}"\n`
          }));
        });
      }

      async refreshFiles() {
        if (!this.isConnected) return;
        
        const list = document.getElementById('fileList');
        list.innerHTML = '<div class="empty-state"><i class="loading"></i><p>Loading...</p></div>';
        
        try {
          const output = await this.executeCommand('ls -1 2>/dev/null || echo ""');
          console.log('File list output:', output);
          
          const lines = output
            .split('\n')
            .map(l => l.trim())
            .filter(l => l && !l.includes('START_') && !l.includes('END_') && !l.includes('echo'));
          
          document.getElementById('pathDisplay').textContent = this.currentPath;
          
          list.innerHTML = '';
          
          // Add parent directory link if not at workspace root
          if (this.currentPath !== `~/${this.workspaceDir}`) {
            const parentItem = document.createElement('div');
            parentItem.className = 'file-item folder';
            parentItem.innerHTML = `
              <i class="fas fa-level-up-alt"></i>
              <span class="file-name">..</span>
            `;
            parentItem.onclick = () => {
              this.openFolder('..');
              this.closeSidebarMobile();
            };
            list.appendChild(parentItem);
          }
          
          if (lines.length === 0) {
            const empty = document.createElement('div');
            empty.className = 'empty-state';
            empty.innerHTML = '<i class="fas fa-folder-open"></i><p>Empty directory</p>';
            list.appendChild(empty);
            return;
          }
          
          // Process files in batches to avoid timeout
          for (const name of lines) {
            try {
              const isDirCheck = await this.executeCommand(`test -d "${name}" && echo "DIR" || echo "FILE"`);
              const isDir = isDirCheck.trim().includes('DIR');
              const item = this.createFileItem(name, isDir);
              list.appendChild(item);
            } catch (err) {
              console.error(`Error checking ${name}:`, err);
              // Default to file if check fails
              const item = this.createFileItem(name, false);
              list.appendChild(item);
            }
          }
        } catch (err) {
          console.error('Failed to load files:', err);
          this.showNotification(`Failed to load files: ${err.message}`, 'error');
          list.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Failed to load files</p><button class="btn" onclick="ide.refreshFiles()" style="margin-top: 1rem;">Retry</button></div>';
        }
      }

      createFileItem(name, isDir) {
        const item = document.createElement('div');
        item.className = `file-item ${isDir ? 'folder' : 'file'}`;
        
        const icon = isDir ? 'fa-folder' : this.getFileIcon(name);
        item.innerHTML = `
          <i class="fas ${icon}"></i>
          <span class="file-name">${this.escapeHtml(name)}</span>
          <div class="file-actions">
            <button class="icon-btn" title="Rename">
              <i class="fas fa-edit"></i>
            </button>
            <button class="icon-btn" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        
        item.onclick = (e) => {
          if (e.target.closest('.file-actions')) return;
          if (isDir) {
            this.openFolder(name);
          } else {
            this.openFile(name);
          }
          this.closeSidebarMobile();
        };

        const actions = item.querySelector('.file-actions');
        actions.children[0].onclick = (e) => {
          e.stopPropagation();
          this.renameItem(name);
        };
        actions.children[1].onclick = (e) => {
          e.stopPropagation();
          this.deleteItem(name);
        };

        return item;
      }

      async openFolder(name) {
        // Prevent going up beyond workspace
        if (name === '..' && this.currentPath === `~/${this.workspaceDir}`) {
          this.showNotification('Cannot navigate above workspace', 'warning');
          return;
        }
        
        // Navigate to folder
        this.ws.send(JSON.stringify({ type: 'input', data: `cd "${name}"\n` }));
        
        // Update current path
        if (name === '..') {
          // Go up one level
          const parts = this.currentPath.split('/');
          parts.pop();
          this.currentPath = parts.join('/') || '~';
        } else {
          // Go into subfolder
          this.currentPath = `${this.currentPath}/${name}`.replace('//', '/');
        }
        
        setTimeout(() => this.refreshFiles(), 300);
      }

      async openFile(filename) {
        if (!this.isConnected) {
          this.showNotification('Not connected', 'warning');
          return;
        }

        const fullPath = `${this.currentPath}/${filename}`.replace('//', '/');
        
        if (this.openFiles.has(fullPath)) {
          this.setActiveFile(fullPath);
          return;
        }

        this.showNotification(`Opening ${filename}...`, 'success');
        
        try {
          const content = await this.executeCommand(`cat "${filename}"`);
          
          document.getElementById('welcome').style.display = 'none';
          document.getElementById('editor').style.display = 'block';
          
          this.openFiles.set(fullPath, {
            filename,
            filepath: fullPath,
            content,
            modified: false
          });

          this.renderTabs();
          this.setActiveFile(fullPath);
          this.showNotification(`Opened ${filename}`, 'success');
        } catch (err) {
          this.showNotification(`Failed to open ${filename}: ${err.message}`, 'error');
        }
      }

      getLanguageFromFilename(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const languageMap = {
          'js': 'javascript',
          'jsx': 'javascript',
          'ts': 'typescript',
          'tsx': 'typescript',
          'json': 'json',
          'html': 'html',
          'css': 'css',
          'scss': 'scss',
          'less': 'less',
          'py': 'python',
          'java': 'java',
          'cpp': 'cpp',
          'c': 'c',
          'cs': 'csharp',
          'php': 'php',
          'rb': 'ruby',
          'go': 'go',
          'rs': 'rust',
          'sql': 'sql',
          'md': 'markdown',
          'xml': 'xml',
          'yaml': 'yaml',
          'yml': 'yaml',
          'sh': 'shell',
          'bash': 'shell',
          'txt': 'plaintext'
        };
        return languageMap[ext] || 'plaintext';
      }

      async saveFile() {
        if (!this.activeFile || !this.openFiles.has(this.activeFile)) {
          this.showNotification('No file open', 'warning');
          return;
        }

        const fileData = this.openFiles.get(this.activeFile);
        const content = this.monacoEditor ? this.monacoEditor.getValue() : '';
        const filename = fileData.filename;

        try {
          const delimiter = `EOF_${Date.now()}`;
          const command = `cat > "${filename}" <<'${delimiter}'\n${content}\n${delimiter}`;
          
          this.ws.send(JSON.stringify({ type: 'input', data: command + '\n' }));
          
          fileData.content = content;
          fileData.modified = false;
          this.renderTabs();
          this.showNotification(`Saved ${filename}`, 'success');
        } catch (err) {
          this.showNotification(`Failed to save ${filename}: ${err.message}`, 'error');
        }
      }

      downloadFile() {
        if (!this.activeFile || !this.openFiles.has(this.activeFile)) {
          this.showNotification('No file open', 'warning');
          return;
        }

        const fileData = this.openFiles.get(this.activeFile);
        const content = this.monacoEditor ? this.monacoEditor.getValue() : '';
        
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileData.filename;
        a.click();
        URL.revokeObjectURL(url);
        
        this.showNotification(`Downloaded ${fileData.filename}`, 'success');
      }

      showNewFileDialog() {
        document.getElementById('fileModalTitle').textContent = 'New File';
        document.getElementById('fileModalLabel').textContent = 'File Name';
        document.getElementById('fileModalInput').value = '';
        document.getElementById('fileModalInput').placeholder = 'filename.txt';
        document.getElementById('fileModal').classList.add('active');
        document.getElementById('fileModalInput').focus();
        
        this.fileModalCallback = async (name) => {
          if (!name) return;
          try {
            this.ws.send(JSON.stringify({ type: 'input', data: `touch "${name}"\n` }));
            this.showNotification(`Created ${name}`, 'success');
            setTimeout(() => this.refreshFiles(), 300);
          } catch (err) {
            this.showNotification(`Failed to create file: ${err.message}`, 'error');
          }
        };
      }

      showNewFolderDialog() {
        document.getElementById('fileModalTitle').textContent = 'New Folder';
        document.getElementById('fileModalLabel').textContent = 'Folder Name';
        document.getElementById('fileModalInput').value = '';
        document.getElementById('fileModalInput').placeholder = 'folder-name';
        document.getElementById('fileModal').classList.add('active');
        document.getElementById('fileModalInput').focus();
        
        this.fileModalCallback = async (name) => {
          if (!name) return;
          try {
            this.ws.send(JSON.stringify({ type: 'input', data: `mkdir "${name}"\n` }));
            this.showNotification(`Created folder ${name}`, 'success');
            setTimeout(() => this.refreshFiles(), 300);
          } catch (err) {
            this.showNotification(`Failed to create folder: ${err.message}`, 'error');
          }
        };
      }

      async renameItem(oldName) {
        const newName = prompt(`Rename "${oldName}" to:`, oldName);
        if (!newName || newName === oldName) return;
        
        try {
          this.ws.send(JSON.stringify({ type: 'input', data: `mv "${oldName}" "${newName}"\n` }));
          this.showNotification(`Renamed to ${newName}`, 'success');
          setTimeout(() => this.refreshFiles(), 300);
        } catch (err) {
          this.showNotification(`Failed to rename: ${err.message}`, 'error');
        }
      }

      async deleteItem(name) {
        if (!confirm(`Delete "${name}"?`)) return;
        
        try {
          this.ws.send(JSON.stringify({ type: 'input', data: `rm -rf "${name}"\n` }));
          this.showNotification(`Deleted ${name}`, 'success');
          setTimeout(() => this.refreshFiles(), 300);
        } catch (err) {
          this.showNotification(`Failed to delete: ${err.message}`, 'error');
        }
      }

      fileModalSubmit() {
        const value = document.getElementById('fileModalInput').value.trim();
        if (value && this.fileModalCallback) {
          this.fileModalCallback(value);
        }
        this.closeModal('fileModal');
      }

      // Tab Management
      renderTabs() {
        const tabs = document.getElementById('tabs');
        tabs.innerHTML = '';

        if (this.openFiles.size === 0) return;

        this.openFiles.forEach((fileData, filepath) => {
          const tab = document.createElement('button');
          tab.className = `tab ${filepath === this.activeFile ? 'active' : ''} ${fileData.modified ? 'modified' : ''}`;
          tab.innerHTML = `
            <i class="fas ${this.getFileIcon(fileData.filename)}"></i>
            <span class="tab-name">${this.escapeHtml(fileData.filename)}</span>
            <i class="fas fa-times tab-close"></i>
          `;
          
          tab.onclick = (e) => {
            if (e.target.classList.contains('tab-close') || e.target.closest('.tab-close')) {
              e.stopPropagation();
              this.closeTab(filepath);
            } else {
              this.setActiveFile(filepath);
            }
          };

          tabs.appendChild(tab);
        });
      }

      setActiveFile(filepath) {
        if (!this.openFiles.has(filepath)) return;
        
        this.activeFile = filepath;
        const fileData = this.openFiles.get(filepath);
        
        // Create or update Monaco editor
        if (this.monacoReady && typeof monaco !== 'undefined') {
          const container = document.getElementById('editor');
          
          if (this.monacoEditor) {
            // Update existing editor
            const language = this.getLanguageFromFilename(fileData.filename);
            const model = monaco.editor.createModel(fileData.content, language);
            this.monacoEditor.setModel(model);
          } else {
            // Create new editor
            const language = this.getLanguageFromFilename(fileData.filename);
            this.monacoEditor = monaco.editor.create(container, {
              value: fileData.content,
              language: language,
              theme: this.theme === 'dark' ? 'vs-dark' : 'vs',
              automaticLayout: true,
              fontSize: 14,
              minimap: { enabled: true },
              scrollBeyondLastLine: false,
              wordWrap: 'on',
              tabSize: 2,
              insertSpaces: true
            });
            
            // Listen for changes
            this.monacoEditor.onDidChangeModelContent(() => {
              if (this.activeFile && this.openFiles.has(this.activeFile)) {
                const fileData = this.openFiles.get(this.activeFile);
                fileData.modified = true;
                this.renderTabs();
              }
            });
          }
        }
        
        this.renderTabs();
      }

      closeTab(filepath) {
        const fileData = this.openFiles.get(filepath);
        if (!fileData) return;
        
        if (fileData.modified) {
          if (!confirm(`${fileData.filename} has unsaved changes. Close anyway?`)) {
            return;
          }
        }
        
        this.openFiles.delete(filepath);
        
        if (this.activeFile === filepath) {
          const remaining = Array.from(this.openFiles.keys());
          if (remaining.length > 0) {
            this.setActiveFile(remaining[0]);
          } else {
            this.activeFile = null;
            if (this.monacoEditor) {
              this.monacoEditor.dispose();
              this.monacoEditor = null;
            }
            document.getElementById('editor').style.display = 'none';
            document.getElementById('welcome').style.display = 'flex';
          }
        }
        
        this.renderTabs();
      }

      // Theme
      toggleTheme() {
        this.theme = this.theme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', this.theme);
        document.getElementById('themeIcon').className = this.theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        
        // Update terminal theme
        this.terminal.options.theme = this.theme === 'dark' ? {
          background: '#1e1e1e', foreground: '#d4d4d4', cursor: '#00ff00'
        } : {
          background: '#ffffff', foreground: '#333333', cursor: '#0078d4'
        };
        
        // Update Monaco theme
        if (this.monacoEditor) {
          monaco.editor.setTheme(this.theme === 'dark' ? 'vs-dark' : 'vs');
        }
        
        this.showNotification(`Switched to ${this.theme} theme`, 'success');
      }

      // Utilities
      getFileIcon(filename) {
        const ext = (filename.split('.').pop() || '').toLowerCase();
        const icons = {
          js: 'fa-file-code', jsx: 'fa-file-code', ts: 'fa-file-code', tsx: 'fa-file-code',
          html: 'fa-file-code', css: 'fa-file-code', scss: 'fa-file-code',
          json: 'fa-file-code', xml: 'fa-file-code', yaml: 'fa-file-code', yml: 'fa-file-code',
          md: 'fa-file-alt', txt: 'fa-file-alt',
          py: 'fa-file-code', java: 'fa-file-code', cpp: 'fa-file-code', c: 'fa-file-code',
          go: 'fa-file-code', rs: 'fa-file-code', php: 'fa-file-code', rb: 'fa-file-code',
          sh: 'fa-file-code', bash: 'fa-file-code',
          jpg: 'fa-file-image', jpeg: 'fa-file-image', png: 'fa-file-image', gif: 'fa-file-image',
          pdf: 'fa-file-pdf', zip: 'fa-file-archive', tar: 'fa-file-archive', gz: 'fa-file-archive'
        };
        return icons[ext] || 'fa-file';
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
      }

      showNotification(message, type = 'success') {
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        
        const icons = {
          success: 'check-circle',
          error: 'exclamation-circle',
          warning: 'exclamation-triangle'
        };

        notif.innerHTML = `
          <i class="fas fa-${icons[type]}"></i>
          <span>${message}</span>
        `;

        document.body.appendChild(notif);

        setTimeout(() => {
          notif.style.animation = 'slideOut 0.3s';
          setTimeout(() => notif.remove(), 300);
        }, 3000);
      }
    }

    // Initialize IDE
    const ide = new WebIDE();
  </script>
</body>
</html>

